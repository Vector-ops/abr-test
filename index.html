<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>HLS Video Player with Transcoding</title>

        <style>
            body {
                font-family: sans-serif;
                background: #111;
                color: #fff;
                padding: 20px;
                margin: 0;
            }

            .section {
                margin-bottom: 30px;
                background: #1a1a1a;
                padding: 20px;
                border-radius: 8px;
            }

            h1 {
                margin-top: 0;
                color: #4a9eff;
            }

            h2 {
                margin-top: 0;
                margin-bottom: 15px;
                color: #6ab7ff;
            }

            .video-list {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 15px;
                margin-bottom: 20px;
            }

            .video-card {
                background: #2a2a2a;
                padding: 15px;
                border-radius: 6px;
                border: 2px solid #333;
                transition: all 0.3s;
            }

            .video-card:hover {
                border-color: #4a9eff;
            }

            .video-card.selected {
                border-color: #4a9eff;
                background: #2a3a4a;
            }

            .video-name {
                font-weight: bold;
                margin-bottom: 8px;
                word-break: break-all;
            }

            .status-badge {
                display: inline-block;
                padding: 4px 10px;
                border-radius: 4px;
                font-size: 12px;
                margin-bottom: 8px;
            }

            .status-completed {
                background: #2d5;
                color: #000;
            }

            .status-processing {
                background: #fa0;
                color: #000;
            }

            .status-not-transcoded {
                background: #666;
                color: #fff;
            }

            .status-failed {
                background: #f44;
                color: #fff;
            }

            button {
                background: #4a9eff;
                color: #fff;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                margin-right: 5px;
                margin-bottom: 5px;
                transition: background 0.3s;
            }

            button:hover {
                background: #3a7fcf;
            }

            button:disabled {
                background: #555;
                cursor: not-allowed;
            }

            .players-container {
                display: none;
                flex-direction: row;
                gap: 20px;
            }

            .players-container.active {
                display: flex;
            }

            .player-container {
                width: 33.33%;
            }

            video {
                width: 100%;
                background: #000;
                border-radius: 4px;
            }

            .quality {
                font-size: 14px;
                margin-top: 5px;
                opacity: 0.8;
            }

            .loading {
                text-align: center;
                padding: 20px;
                color: #4a9eff;
            }

            .error {
                color: #f44;
                padding: 10px;
                background: #2a1a1a;
                border-radius: 4px;
                margin-top: 10px;
            }

            .info {
                color: #fa0;
                padding: 10px;
                background: #2a2410;
                border-radius: 4px;
                margin-top: 10px;
            }
        </style>

        <!-- HLS.js -->
        <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

        <!-- Shaka Player -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.10.0/shaka-player.compiled.js"></script>

        <!-- Video.js -->
        <link
            href="https://vjs.zencdn.net/8.6.1/video-js.css"
            rel="stylesheet"
        />
        <script src="https://vjs.zencdn.net/8.6.1/video.min.js"></script>
    </head>

    <body>
        <h1>HLS Adaptive Bitrate Video Player</h1>

        <div class="section">
            <h2>Available Videos</h2>
            <div id="videoList" class="video-list">
                <div class="loading">Loading videos...</div>
            </div>
            <div id="errorMessage"></div>
        </div>

        <div class="section">
            <h2>Video Players</h2>
            <div id="playerInfo" class="info" style="display: none">
                Select a transcoded video to start playback
            </div>
            <div id="playersContainer" class="players-container">
                <!-- HLS.js -->
                <div class="player-container">
                    <h2>HLS.js</h2>
                    <video id="hlsPlayer" controls></video>
                    <div id="hlsQuality" class="quality">Quality: -</div>
                </div>

                <!-- Shaka -->
                <div class="player-container">
                    <h2>Shaka Player</h2>
                    <video id="shakaPlayer" controls></video>
                    <div id="shakaQuality" class="quality">Quality: -</div>
                </div>

                <!-- Video.js -->
                <div class="player-container">
                    <h2>Video.js</h2>
                    <video
                        id="videojsPlayer"
                        class="video-js vjs-default-skin"
                        controls
                    ></video>
                    <div id="vjsQuality" class="quality">Quality: -</div>
                </div>
            </div>
        </div>

        <script>
            const API_BASE = "http://localhost:8000";
            let videos = [];
            let selectedVideo = null;
            let hls = null;
            let shakaPlayer = null;
            let vjs = null;
            let qualityUpdateInterval = null;

            // Load videos on page load
            loadVideos();

            // Poll for status updates every 3 seconds
            setInterval(loadVideos, 3000);

            async function loadVideos() {
                try {
                    const response = await fetch(`${API_BASE}/api/videos`);
                    if (!response.ok) throw new Error("Failed to load videos");

                    videos = await response.json();
                    renderVideoList();
                } catch (error) {
                    showError("Error loading videos: " + error.message);
                }
            }

            function renderVideoList() {
                const container = document.getElementById("videoList");

                if (videos.length === 0) {
                    container.innerHTML =
                        '<div class="loading">No videos found in the videos folder</div>';
                    return;
                }

                container.innerHTML = videos
                    .map((video) => {
                        const statusClass =
                            video.status === "completed"
                                ? "status-completed"
                                : video.status === "processing"
                                  ? "status-processing"
                                  : video.status === "failed"
                                    ? "status-failed"
                                    : "status-not-transcoded";

                        const statusText =
                            video.status === "completed"
                                ? "Ready"
                                : video.status === "processing"
                                  ? "Processing..."
                                  : video.status === "failed"
                                    ? "Failed"
                                    : "Not Transcoded";

                        const isSelected =
                            selectedVideo && selectedVideo.name === video.name;

                        return `
                        <div class="video-card ${isSelected ? "selected" : ""}" id="card-${video.name}">
                            <div class="video-name">${video.name}</div>
                            <div class="status-badge ${statusClass}">${statusText}</div>
                            <div>
                                ${
                                    !video.transcoded
                                        ? `
                                    <button onclick="transcodeVideo('${video.name}')"
                                            ${video.status === "processing" ? "disabled" : ""}>
                                        Transcode
                                    </button>
                                `
                                        : ""
                                }
                                ${
                                    video.status === "completed"
                                        ? `
                                    <button onclick="playVideo('${video.name}', '${video.stream_url}')">
                                        Play
                                    </button>
                                `
                                        : ""
                                }
                                ${
                                    video.status === "processing"
                                        ? `
                                    <button onclick="checkStatus('${video.name}')">
                                        Check Status
                                    </button>
                                `
                                        : ""
                                }
                            </div>
                        </div>
                    `;
                    })
                    .join("");
            }

            async function transcodeVideo(videoName) {
                try {
                    showError("");
                    const response = await fetch(
                        `${API_BASE}/api/transcode?video=${encodeURIComponent(videoName)}`,
                        {
                            method: "POST",
                        },
                    );

                    if (!response.ok)
                        throw new Error("Transcode request failed");

                    const result = await response.json();
                    showInfo(
                        `Transcoding started for ${videoName}. This may take a few minutes...`,
                    );

                    // Reload video list after a short delay
                    setTimeout(loadVideos, 1000);
                } catch (error) {
                    showError("Error starting transcode: " + error.message);
                }
            }

            async function checkStatus(videoName) {
                try {
                    const response = await fetch(
                        `${API_BASE}/api/status/${encodeURIComponent(videoName)}`,
                    );
                    if (!response.ok) throw new Error("Status check failed");

                    const result = await response.json();
                    showInfo(`Status for ${videoName}: ${result.status}`);
                    loadVideos();
                } catch (error) {
                    showError("Error checking status: " + error.message);
                }
            }

            function playVideo(videoName, streamUrl) {
                selectedVideo = {
                    name: videoName,
                    url: `${API_BASE}${streamUrl}`,
                };

                // Highlight selected video
                renderVideoList();

                // Show players
                document.getElementById("playerInfo").style.display = "none";
                document
                    .getElementById("playersContainer")
                    .classList.add("active");

                // Initialize players
                initializePlayers(selectedVideo.url);

                showInfo(`Now playing: ${videoName}`);
            }

            function initializePlayers(hlsUrl) {
                // Clean up existing players
                cleanupPlayers();

                // Initialize HLS.js
                const hlsVideo = document.getElementById("hlsPlayer");
                if (Hls.isSupported()) {
                    hls = new Hls();
                    hls.loadSource(hlsUrl);
                    hls.attachMedia(hlsVideo);
                } else if (
                    hlsVideo.canPlayType("application/vnd.apple.mpegurl")
                ) {
                    hlsVideo.src = hlsUrl;
                }

                // Initialize Shaka Player
                const shakaVideo = document.getElementById("shakaPlayer");
                shaka.polyfill.installAll();
                shakaPlayer = new shaka.Player(shakaVideo);
                shakaPlayer.configure({
                    manifest: { hls: { useFullSegmentsForStartTime: false } },
                });
                shakaPlayer
                    .load(hlsUrl)
                    .catch((e) => console.error("Shaka error:", e));

                // Initialize Video.js
                vjs = videojs("videojsPlayer", {
                    controls: true,
                    preload: "auto",
                    sources: [{ src: hlsUrl, type: "application/x-mpegURL" }],
                });

                // Start quality monitoring
                startQualityMonitoring();
            }

            function cleanupPlayers() {
                if (qualityUpdateInterval) {
                    clearInterval(qualityUpdateInterval);
                    qualityUpdateInterval = null;
                }

                if (hls) {
                    hls.destroy();
                    hls = null;
                }

                if (shakaPlayer) {
                    shakaPlayer.destroy();
                    shakaPlayer = null;
                }

                if (vjs) {
                    vjs.dispose();
                    vjs = null;
                }
            }

            function startQualityMonitoring() {
                qualityUpdateInterval = setInterval(() => {
                    updateHlsQuality();
                    updateShakaQuality();
                    updateVjsQuality();
                }, 500);
            }

            function updateHlsQuality() {
                if (!hls || hls.currentLevel < 0) return;
                const lvl = hls.levels[hls.currentLevel];
                if (!lvl) return;

                document.getElementById("hlsQuality").textContent =
                    `Quality: ${lvl.height}p (${Math.round(lvl.bitrate / 1000)} kbps)`;
            }

            function updateShakaQuality() {
                if (!shakaPlayer) return;
                const tracks = shakaPlayer.getVariantTracks();
                const active = tracks.find((t) => t.active);
                if (!active) return;

                document.getElementById("shakaQuality").textContent =
                    `Quality: ${active.height}p (${Math.round(active.bandwidth / 1000)} kbps)`;
            }

            function updateVjsQuality() {
                if (!vjs) return;
                const tech = vjs.tech();
                const vhs = tech?.vhs;
                const media = vhs?.playlists?.media?.();
                if (!media || !media.attributes) return;

                const height = media.attributes.RESOLUTION?.height;
                const bw = media.attributes.BANDWIDTH;

                if (height) {
                    document.getElementById("vjsQuality").textContent =
                        `Quality: ${height}p (${Math.round(bw / 1000)} kbps)`;
                }
            }

            function showError(message) {
                const errorDiv = document.getElementById("errorMessage");
                if (message) {
                    errorDiv.innerHTML = `<div class="error">${message}</div>`;
                } else {
                    errorDiv.innerHTML = "";
                }
            }

            function showInfo(message) {
                const errorDiv = document.getElementById("errorMessage");
                if (message) {
                    errorDiv.innerHTML = `<div class="info">${message}</div>`;
                } else {
                    errorDiv.innerHTML = "";
                }
            }

            // Cleanup on page unload
            window.addEventListener("beforeunload", cleanupPlayers);
        </script>
    </body>
</html>
